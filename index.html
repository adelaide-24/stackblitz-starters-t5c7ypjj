<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MaterialStock</title>
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Source+Sans+3:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      /* ========================================
           VARIABLES & RESET
           ======================================== */
      :root {
        --sand-lightest: #faf8f5;
        --sand-light: #f5f0e8;
        --sand: #e8e0d0;
        --sand-dark: #d4c4a8;
        --beige: #c4b49a;
        --white: #ffffff;
        --black: #1a1a1a;
        --gray-700: #4a4a4a;
        --gray-500: #6b6b6b;
        --gray-400: #8a8a8a;
        --success: #4a7c59;
        --success-light: rgba(74, 124, 89, 0.12);
        --warning: #b8860b;
        --warning-light: rgba(184, 134, 11, 0.12);
        --danger: #a65d57;
        --danger-light: rgba(166, 93, 87, 0.12);
        --font-heading: 'DM Sans', sans-serif;
        --font-body: 'Source Sans 3', sans-serif;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 16px;
        --radius-2xl: 20px;
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.07);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: var(--font-body);
        background: var(--sand-light);
        color: var(--black);
        min-height: 100vh;
        line-height: 1.5;
      }

      h1,
      h2,
      h3 {
        font-family: var(--font-heading);
        font-weight: 600;
      }
      button {
        font-family: inherit;
        cursor: pointer;
        border: none;
        background: none;
      }
      input,
      select,
      textarea {
        font-family: inherit;
        font-size: 1rem;
      }

      /* ========================================
           SCREENS
           ======================================== */
      .screen {
        display: none;
        min-height: 100vh;
      }
      .screen.active {
        display: flex;
      }

      /* ========================================
           AUTH SCREEN
           ======================================== */
      #auth-screen {
        align-items: center;
        justify-content: center;
        padding: 24px;
        background: linear-gradient(145deg, var(--sand-lightest), var(--sand));
      }

      .auth-container {
        background: var(--white);
        border-radius: var(--radius-2xl);
        box-shadow: var(--shadow-xl);
        padding: 40px;
        width: 100%;
        max-width: 420px;
      }

      .auth-header {
        text-align: center;
        margin-bottom: 32px;
      }
      .logo {
        margin-bottom: 16px;
      }
      .app-title {
        font-size: 1.5rem;
        margin-bottom: 8px;
      }
      .app-subtitle {
        color: var(--gray-500);
        font-size: 0.9rem;
      }

      .auth-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        background: var(--sand-light);
        border-radius: var(--radius-lg);
        padding: 4px;
      }

      .tab-btn {
        flex: 1;
        padding: 12px;
        font-family: var(--font-heading);
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--gray-500);
        border-radius: var(--radius-md);
        transition: all 0.15s;
      }

      .tab-btn:hover {
        color: var(--black);
      }
      .tab-btn.active {
        background: var(--white);
        color: var(--black);
        box-shadow: var(--shadow-md);
      }

      .auth-form {
        display: none;
      }
      .auth-form.active {
        display: block;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-group label {
        display: block;
        font-family: var(--font-heading);
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--gray-700);
        margin-bottom: 8px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--sand);
        border-radius: var(--radius-md);
        background: var(--white);
        transition: all 0.15s;
        color: var(--black);
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--beige);
        box-shadow: 0 0 0 3px rgba(196, 180, 154, 0.2);
      }

      .form-group input::placeholder {
        color: var(--gray-400);
      }
      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 20px;
        font-family: var(--font-heading);
        font-weight: 600;
        font-size: 0.9rem;
        border-radius: var(--radius-md);
        transition: all 0.15s;
      }

      .btn-primary {
        background: var(--black);
        color: var(--white);
      }
      .btn-primary:hover {
        background: #333;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }
      .btn-full {
        width: 100%;
        padding: 16px;
        font-size: 1rem;
        margin-top: 8px;
      }
      .btn-secondary {
        background: var(--sand);
        color: var(--black);
      }
      .btn-secondary:hover {
        background: var(--sand-dark);
      }
      .btn-danger {
        background: var(--danger);
        color: var(--white);
      }
      .btn-danger:hover {
        background: #8b4d48;
      }
      .btn-icon {
        width: 40px;
        height: 40px;
        padding: 0;
        background: var(--sand-light);
        border-radius: var(--radius-md);
      }
      .btn-icon:hover {
        background: var(--sand);
      }
      .btn-sm {
        padding: 8px 12px;
        font-size: 0.8rem;
      }

      .auth-error {
        color: var(--danger);
        font-size: 0.875rem;
        text-align: center;
        margin-top: 16px;
        min-height: 20px;
      }

      .demo-hint {
        margin-top: 24px;
        padding: 16px;
        background: var(--sand-lightest);
        border: 1px dashed var(--sand-dark);
        border-radius: var(--radius-md);
        text-align: center;
        font-size: 0.875rem;
        color: var(--gray-500);
        line-height: 1.6;
      }

      .demo-hint code {
        background: var(--sand);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8rem;
        color: var(--black);
      }

      /* ========================================
           DASHBOARD
           ======================================== */
      #dashboard-screen {
        flex-direction: column;
        background: var(--sand-lightest);
      }

      .main-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 64px;
        padding: 0 24px;
        background: var(--white);
        border-bottom: 1px solid var(--sand);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .header-title {
        font-size: 1.125rem;
      }
      .header-right {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .user-info {
        text-align: right;
      }
      .user-name {
        font-family: var(--font-heading);
        font-weight: 600;
        font-size: 0.875rem;
      }
      .user-org {
        font-size: 0.75rem;
        color: var(--gray-500);
      }

      .toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        padding: 12px 24px;
        background: var(--white);
        border-bottom: 1px solid var(--sand);
      }

      .search-container {
        position: relative;
        flex: 1;
        max-width: 400px;
      }

      .search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-400);
        pointer-events: none;
      }

      .search-input {
        width: 100%;
        height: 42px;
        padding: 0 16px 0 48px;
        border: 2px solid var(--sand);
        border-radius: var(--radius-lg);
        background: var(--sand-lightest);
        font-size: 0.9rem;
      }

      .search-input:focus {
        border-color: var(--beige);
        background: var(--white);
        outline: none;
      }

      .stats-bar {
        display: flex;
        align-items: center;
        gap: 24px;
        padding: 12px 24px;
        background: var(--sand-light);
        border-bottom: 1px solid var(--sand);
      }

      .stat-item {
        display: flex;
        align-items: baseline;
        gap: 8px;
      }
      .stat-value {
        font-family: var(--font-heading);
        font-weight: 700;
        font-size: 1.25rem;
      }
      .stat-label {
        font-size: 0.875rem;
        color: var(--gray-500);
      }
      .stat-divider {
        width: 1px;
        height: 24px;
        background: var(--sand-dark);
      }

      .main-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }

      /* ========================================
           TABLE
           ======================================== */
      .materials-table-container {
        background: var(--white);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        overflow: hidden;
      }

      .materials-table {
        width: 100%;
        border-collapse: collapse;
      }
      .materials-table thead {
        background: var(--sand-lightest);
      }

      .materials-table th {
        padding: 16px;
        font-family: var(--font-heading);
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--gray-500);
        text-align: left;
        border-bottom: 2px solid var(--sand);
      }

      .materials-table th.sortable {
        cursor: pointer;
        user-select: none;
      }
      .materials-table th.sortable:hover {
        color: var(--black);
      }

      .materials-table td {
        padding: 16px;
        border-bottom: 1px solid var(--sand-light);
        vertical-align: middle;
      }

      .materials-table tbody tr {
        cursor: pointer;
        transition: background 0.15s;
      }
      .materials-table tbody tr:hover {
        background: var(--sand-lightest);
      }

      .col-image {
        width: 80px;
      }
      .col-quantity {
        width: 100px;
        text-align: center !important;
      }
      .col-condition {
        width: 130px;
      }
      .col-actions {
        width: 100px;
        text-align: center !important;
      }

      .table-image {
        width: 56px;
        height: 56px;
        border-radius: var(--radius-md);
        object-fit: cover;
        background: var(--sand-light);
      }

      .table-image-placeholder {
        width: 56px;
        height: 56px;
        border-radius: var(--radius-md);
        background: var(--sand-light);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .material-name {
        font-family: var(--font-heading);
        font-weight: 600;
        font-size: 0.95rem;
      }
      .material-location {
        font-size: 0.85rem;
        color: var(--gray-500);
        margin-top: 2px;
      }

      .condition-badge {
        display: inline-block;
        padding: 4px 12px;
        font-family: var(--font-heading);
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 9999px;
        text-transform: capitalize;
      }

      .condition-badge.ottimo {
        background: var(--success-light);
        color: var(--success);
      }
      .condition-badge.buono {
        background: rgba(74, 124, 89, 0.08);
        color: #5a8c69;
      }
      .condition-badge.discreto {
        background: var(--warning-light);
        color: var(--warning);
      }
      .condition-badge.da-verificare {
        background: var(--danger-light);
        color: var(--danger);
      }

      .quantity-badge {
        display: inline-block;
        padding: 4px 12px;
        font-family: var(--font-heading);
        font-size: 0.875rem;
        font-weight: 600;
        border-radius: 9999px;
        background: var(--sand-light);
        color: var(--gray-500);
      }

      .action-btn {
        width: 36px;
        height: 36px;
        border-radius: var(--radius-md);
        color: var(--gray-400);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }

      .action-btn:hover {
        background: var(--sand);
        color: var(--black);
      }
      .action-btn.edit-btn:hover {
        color: var(--success);
      }
      .action-btn.delete-btn:hover {
        color: var(--danger);
      }

      .actions-cell {
        display: flex;
        gap: 4px;
        justify-content: center;
      }

      /* ========================================
           CARDS (Mobile)
           ======================================== */
      .materials-cards {
        display: none;
        flex-direction: column;
        gap: 16px;
      }

      .material-card {
        background: var(--white);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
      }

      .material-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .card-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
        background: var(--sand-light);
      }

      .card-image-placeholder {
        width: 100%;
        height: 140px;
        background: linear-gradient(135deg, var(--sand-light), var(--sand));
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .card-content {
        padding: 16px;
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
      }
      .card-title {
        font-family: var(--font-heading);
        font-weight: 600;
        font-size: 1rem;
      }
      .card-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .card-detail-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        color: var(--gray-400);
        letter-spacing: 0.05em;
      }
      .card-detail-value {
        font-family: var(--font-heading);
        font-weight: 500;
        font-size: 0.9rem;
        margin-top: 2px;
      }

      /* ========================================
           EMPTY STATE
           ======================================== */
      .empty-state,
      .no-results-state {
        display: none;
        flex-direction: column;
        align-items: center;
        padding: 64px 24px;
        text-align: center;
      }

      .empty-state.visible,
      .no-results-state.visible {
        display: flex;
      }
      .empty-state h3,
      .no-results-state h3 {
        margin: 24px 0 8px;
        font-size: 1.25rem;
      }
      .empty-state p,
      .no-results-state p {
        color: var(--gray-500);
        margin-bottom: 24px;
        max-width: 300px;
      }

      /* ========================================
           MODALS
           ======================================== */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }

      .modal.active {
        display: flex;
      }

      .modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
      }

      .modal-content {
        position: relative;
        background: var(--white);
        border-radius: var(--radius-2xl);
        box-shadow: var(--shadow-xl);
        max-height: 90vh;
        overflow-y: auto;
        animation: modalIn 0.3s ease;
      }

      @keyframes modalIn {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--white);
        color: var(--gray-500);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        box-shadow: var(--shadow-md);
        transition: all 0.15s;
      }

      .modal-close:hover {
        background: var(--sand-light);
        color: var(--black);
      }

      .modal-title {
        font-size: 1.25rem;
        margin-bottom: 24px;
      }

      /* Detail Modal */
      .modal-detail {
        width: 100%;
        max-width: 600px;
      }

      .detail-image-container {
        width: 100%;
        height: 250px;
        background: var(--sand-light);
        position: relative;
      }

      .detail-image-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .detail-image-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--sand-light), var(--sand));
      }

      .detail-content {
        padding: 24px;
      }
      .detail-title {
        font-size: 1.35rem;
        margin-bottom: 16px;
        line-height: 1.3;
      }
      .detail-badge-row {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }

      .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--sand);
      }

      .detail-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .detail-item.full-width {
        grid-column: 1 / -1;
      }
      .detail-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        color: var(--gray-400);
        font-weight: 600;
        letter-spacing: 0.05em;
      }
      .detail-value {
        font-family: var(--font-heading);
        font-weight: 500;
        color: var(--black);
      }

      .detail-notes {
        padding: 16px;
        background: var(--sand-lightest);
        border-radius: var(--radius-lg);
        margin-bottom: 24px;
      }

      .detail-notes .detail-label {
        margin-bottom: 8px;
      }
      .detail-notes p {
        font-size: 0.95rem;
        color: var(--gray-700);
        white-space: pre-wrap;
        line-height: 1.6;
      }

      .detail-meta {
        display: flex;
        gap: 20px;
        font-size: 0.75rem;
        color: var(--gray-400);
        margin-bottom: 24px;
      }
      .detail-actions {
        display: flex;
        gap: 12px;
      }
      .detail-actions .btn {
        flex: 1;
      }

      /* Form Modal */
      .modal-form {
        width: 100%;
        max-width: 580px;
        padding: 32px;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .image-upload {
        position: relative;
      }

      .image-preview {
        border: 2px dashed var(--sand-dark);
        border-radius: var(--radius-lg);
        padding: 40px 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        background: var(--sand-lightest);
        transition: all 0.2s;
      }

      .image-preview:hover {
        border-color: var(--beige);
        background: var(--sand-light);
      }
      .image-preview span {
        font-size: 0.9rem;
        color: var(--gray-700);
        font-weight: 500;
      }
      .image-preview small {
        font-size: 0.75rem;
        color: var(--gray-400);
      }

      .image-uploaded {
        position: relative;
        border-radius: var(--radius-lg);
        overflow: hidden;
      }
      .image-uploaded img {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }

      .btn-remove-image {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--white);
        color: var(--danger);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-md);
        transition: all 0.15s;
      }

      .btn-remove-image:hover {
        background: var(--danger);
        color: var(--white);
      }

      .form-group select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236B6B6B' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 16px center;
        padding-right: 48px;
        -webkit-appearance: none;
        cursor: pointer;
      }

      .form-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid var(--sand);
      }

      .form-actions .btn {
        flex: 1;
        padding: 16px;
      }

      /* Confirm Modal */
      .modal-confirm {
        width: 100%;
        max-width: 420px;
        padding: 32px;
        text-align: center;
      }
      .confirm-icon {
        margin-bottom: 16px;
      }
      .modal-text {
        color: var(--gray-500);
        margin-bottom: 16px;
        line-height: 1.5;
      }
      .modal-material-name {
        font-family: var(--font-heading);
        font-weight: 600;
        padding: 12px 16px;
        background: var(--sand-lightest);
        border-radius: var(--radius-md);
        margin-bottom: 24px;
        word-break: break-word;
      }

      /* ========================================
           TOAST
           ======================================== */
      .toast {
        position: fixed;
        bottom: 32px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        z-index: 2000;
        transition: transform 0.3s ease;
        pointer-events: none;
      }

      .toast.visible {
        transform: translateX(-50%) translateY(0);
      }

      .toast-content {
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--black);
        color: var(--white);
        padding: 16px 24px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        font-family: var(--font-heading);
        font-weight: 500;
      }

      .toast-icon {
        color: #6fcf97;
      }
      .toast.error .toast-icon {
        color: #eb5757;
      }

      /* ========================================
           RESPONSIVE
           ======================================== */
      @media (max-width: 900px) {
        .col-location-header {
          display: none;
        }
        .material-location {
          display: none;
        }
      }

      @media (max-width: 768px) {
        .materials-table-container {
          display: none !important;
        }
        .materials-cards {
          display: flex;
        }
        .toolbar {
          flex-direction: column;
          padding: 16px;
        }
        .search-container {
          max-width: none;
          width: 100%;
        }
        .btn-add {
          width: 100%;
        }
        .stats-bar {
          justify-content: space-around;
          flex-wrap: wrap;
          padding: 16px;
        }
        .stat-divider {
          display: none;
        }
        .stat-item {
          flex-direction: column;
          align-items: center;
        }
        .user-info {
          display: none;
        }
        .main-content {
          padding: 16px;
        }
        .form-row {
          grid-template-columns: 1fr;
        }
        .detail-grid {
          grid-template-columns: 1fr;
        }
        .detail-actions {
          flex-direction: column;
        }
        .modal {
          align-items: flex-end;
          padding: 8px;
        }
        .modal-content {
          border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
          max-height: 95vh;
        }
        .auth-container {
          padding: 24px;
        }
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: var(--sand-light);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--beige);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--sand-dark);
      }
    </style>
  </head>
  <body>
    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="screen active">
      <div class="auth-container">
        <div class="auth-header">
          <div class="logo">
            <svg width="56" height="56" viewBox="0 0 48 48" fill="none">
              <rect x="4" y="20" width="16" height="24" rx="2" fill="#1A1A1A" />
              <rect
                x="24"
                y="12"
                width="20"
                height="32"
                rx="2"
                fill="#C4B49A"
              />
              <rect x="8" y="4" width="12" height="12" rx="2" fill="#D4C4A8" />
              <circle cx="12" cy="32" r="3" fill="#F5F0E8" />
              <rect x="28" y="18" width="12" height="3" rx="1" fill="#1A1A1A" />
              <rect x="28" y="24" width="12" height="3" rx="1" fill="#1A1A1A" />
            </svg>
          </div>
          <h1 class="app-title">MaterialStock</h1>
          <p class="app-subtitle">
            Gestione materiali per il riciclo da allestimenti
          </p>
        </div>

        <div class="auth-tabs">
          <button class="tab-btn active" onclick="switchTab('login')">
            Accedi
          </button>
          <button class="tab-btn" onclick="switchTab('register')">
            Registrati
          </button>
        </div>

        <form
          id="login-form"
          class="auth-form active"
          onsubmit="handleLogin(event)"
        >
          <div class="form-group">
            <label>Email</label>
            <input
              type="email"
              id="login-email"
              required
              placeholder="nome@email.com"
            />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input
              type="password"
              id="login-password"
              required
              placeholder="Inserisci password"
            />
          </div>
          <button type="submit" class="btn btn-primary btn-full">Accedi</button>
          <p class="auth-error" id="login-error"></p>
        </form>

        <form
          id="register-form"
          class="auth-form"
          onsubmit="handleRegister(event)"
        >
          <div class="form-group">
            <label>Nome completo</label>
            <input
              type="text"
              id="register-name"
              required
              placeholder="Mario Rossi"
            />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input
              type="email"
              id="register-email"
              required
              placeholder="nome@email.com"
            />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input
              type="password"
              id="register-password"
              required
              minlength="6"
              placeholder="Minimo 6 caratteri"
            />
          </div>
          <div class="form-group">
            <label>Organizzazione (opzionale)</label>
            <input type="text" id="register-org" placeholder="Nome azienda" />
          </div>
          <button type="submit" class="btn btn-primary btn-full">
            Crea account
          </button>
          <p class="auth-error" id="register-error"></p>
        </form>

        <div class="demo-hint">
          <strong>üîê Account demo:</strong><br />
          Email: <code>adelaide.penzo.ar24@itsmarcopolo.it</code><br />
          Password: <code>admin1234</code>
        </div>
      </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboard-screen" class="screen">
      <header class="main-header">
        <div class="header-left">
          <svg width="36" height="36" viewBox="0 0 48 48" fill="none">
            <rect x="4" y="20" width="16" height="24" rx="2" fill="#1A1A1A" />
            <rect x="24" y="12" width="20" height="32" rx="2" fill="#C4B49A" />
            <rect x="8" y="4" width="12" height="12" rx="2" fill="#D4C4A8" />
          </svg>
          <h1 class="header-title">Archivio Opere</h1>
        </div>
        <div class="header-right">
          <div class="user-info">
            <div class="user-name" id="user-name"></div>
            <div class="user-org" id="user-org"></div>
          </div>
          <button class="btn btn-icon" onclick="handleLogout()" title="Esci">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
              <polyline points="16,17 21,12 16,7" />
              <line x1="21" y1="12" x2="9" y2="12" />
            </svg>
          </button>
        </div>
      </header>

      <div class="toolbar">
        <div class="search-container">
          <svg
            class="search-icon"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
          </svg>
          <input
            type="text"
            id="search-input"
            class="search-input"
            placeholder="Cerca materiali..."
            oninput="handleSearch()"
          />
        </div>
        <button class="btn btn-primary btn-add" onclick="openAddModal()">
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
          >
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
          </svg>
          <span>Nuovo Materiale</span>
        </button>
      </div>

      <div class="stats-bar">
        <div class="stat-item">
          <span class="stat-value" id="stat-total">0</span>
          <span class="stat-label">materiali</span>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
          <span class="stat-value" id="stat-pieces">0</span>
          <span class="stat-label">pezzi totali</span>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
          <span class="stat-value" id="stat-good">0</span>
          <span class="stat-label">in buono stato</span>
        </div>
      </div>

      <main class="main-content">
        <div class="materials-table-container" id="table-container">
          <table class="materials-table">
            <thead>
              <tr>
                <th class="col-image">Foto</th>
                <th class="sortable" onclick="handleSort('name')">Materiale</th>
                <th
                  class="col-quantity sortable"
                  onclick="handleSort('quantity')"
                >
                  Pezzi
                </th>
                <th
                  class="col-condition sortable"
                  onclick="handleSort('condition')"
                >
                  Stato
                </th>
                <th
                  class="col-location-header sortable"
                  onclick="handleSort('location')"
                >
                  Collocazione
                </th>
                <th class="col-actions">Azioni</th>
              </tr>
            </thead>
            <tbody id="table-body"></tbody>
          </table>
        </div>

        <div class="materials-cards" id="cards-container"></div>

        <div class="empty-state" id="empty-state">
          <svg
            width="80"
            height="80"
            viewBox="0 0 24 24"
            fill="none"
            stroke="#C4B49A"
            stroke-width="1"
          >
            <path
              d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"
            />
          </svg>
          <h3>Nessun materiale</h3>
          <p>Inizia aggiungendo il primo materiale al tuo archivio</p>
          <button class="btn btn-primary" onclick="openAddModal()">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
            >
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            Aggiungi materiale
          </button>
        </div>

        <div class="no-results-state" id="no-results-state">
          <svg
            width="64"
            height="64"
            viewBox="0 0 24 24"
            fill="none"
            stroke="#C4B49A"
            stroke-width="1.5"
          >
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
          </svg>
          <h3>Nessun risultato</h3>
          <p>Prova con altri termini di ricerca</p>
        </div>
      </main>
    </div>

    <!-- DETAIL MODAL -->
    <div class="modal" id="detail-modal">
      <div class="modal-overlay" onclick="closeModal('detail')"></div>
      <div class="modal-content modal-detail">
        <button class="modal-close" onclick="closeModal('detail')">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
        <div class="detail-image-container">
          <img id="detail-image" src="" alt="" style="display: none" />
          <div id="detail-placeholder" class="detail-image-placeholder">
            <svg
              width="64"
              height="64"
              viewBox="0 0 24 24"
              fill="none"
              stroke="#C4B49A"
              stroke-width="1"
            >
              <rect x="3" y="3" width="18" height="18" rx="2" />
              <circle cx="8.5" cy="8.5" r="1.5" />
              <polyline points="21,15 16,10 5,21" />
            </svg>
          </div>
        </div>
        <div class="detail-content">
          <h2 class="detail-title" id="detail-name"></h2>
          <div class="detail-badge-row">
            <span class="condition-badge" id="detail-condition"></span>
            <span class="quantity-badge" id="detail-quantity"></span>
          </div>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Collocazione</span>
              <span class="detail-value" id="detail-location"></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Provenienza</span>
              <span class="detail-value" id="detail-origin"></span>
            </div>
            <div class="detail-item full-width">
              <span class="detail-label">Destinazione</span>
              <span class="detail-value" id="detail-destination"></span>
            </div>
          </div>
          <div class="detail-notes" id="detail-notes-section">
            <span class="detail-label">Note</span>
            <p id="detail-notes"></p>
          </div>
          <div class="detail-meta">
            <span id="detail-created"></span>
            <span id="detail-updated"></span>
          </div>
          <div class="detail-actions">
            <button class="btn btn-secondary" onclick="openEditModal()">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                />
                <path
                  d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                />
              </svg>
              Modifica
            </button>
            <button class="btn btn-danger" onclick="openDeleteModal()">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="3,6 5,6 21,6" />
                <path
                  d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                />
              </svg>
              Elimina
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- FORM MODAL -->
    <div class="modal" id="form-modal">
      <div class="modal-overlay" onclick="closeModal('form')"></div>
      <div class="modal-content modal-form">
        <button class="modal-close" onclick="closeModal('form')">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
        <h2 class="modal-title" id="form-title">Nuovo Materiale</h2>
        <form onsubmit="handleFormSubmit(event)">
          <input type="hidden" id="form-id" />

          <div class="form-group">
            <label>Immagine</label>
            <div class="image-upload">
              <input
                type="file"
                id="form-image-input"
                accept="image/*"
                onchange="handleImageUpload(event)"
                hidden
              />
              <div
                class="image-preview"
                id="image-preview"
                onclick="document.getElementById('form-image-input').click()"
              >
                <svg
                  width="40"
                  height="40"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="#C4B49A"
                  stroke-width="1.5"
                >
                  <rect x="3" y="3" width="18" height="18" rx="2" />
                  <circle cx="8.5" cy="8.5" r="1.5" />
                  <polyline points="21,15 16,10 5,21" />
                </svg>
                <span>Clicca per caricare un'immagine</span>
                <small>JPG, PNG (max 5MB)</small>
              </div>
              <div class="image-uploaded" id="image-uploaded" hidden>
                <img id="preview-img" src="" alt="" />
                <button
                  type="button"
                  class="btn-remove-image"
                  onclick="removeImage()"
                >
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Nome materiale *</label>
              <input
                type="text"
                id="form-name"
                required
                placeholder="es. Travi in legno di abete"
              />
            </div>
            <div class="form-group">
              <label>Quantit√† (pezzi) *</label>
              <input
                type="number"
                id="form-quantity"
                min="0"
                required
                value="1"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Stato conservazione *</label>
              <select id="form-condition" required>
                <option value="ottimo">Ottimo</option>
                <option value="buono" selected>Buono</option>
                <option value="discreto">Discreto</option>
                <option value="da verificare">Da verificare</option>
              </select>
            </div>
            <div class="form-group">
              <label>Collocazione *</label>
              <input
                type="text"
                id="form-location"
                required
                placeholder="es. Magazzino A - Scaffale 1"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Provenienza (origine)</label>
              <input
                type="text"
                id="form-origin"
                placeholder="es. Biennale Venezia 2023"
              />
            </div>
            <div class="form-group">
              <label>Destinazione</label>
              <input
                type="text"
                id="form-destination"
                placeholder="es. Mostra Milano 2024"
              />
            </div>
          </div>

          <div class="form-group">
            <label>Note aggiuntive</label>
            <textarea
              id="form-notes"
              rows="4"
              placeholder="Inserisci dettagli sul materiale, dimensioni, condizioni particolari..."
            ></textarea>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeModal('form')"
            >
              Annulla
            </button>
            <button type="submit" class="btn btn-primary">
              Salva materiale
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- DELETE MODAL -->
    <div class="modal" id="delete-modal">
      <div class="modal-overlay" onclick="closeModal('delete')"></div>
      <div class="modal-content modal-confirm">
        <div class="confirm-icon">
          <svg
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="#A65D57"
            stroke-width="1.5"
          >
            <circle cx="12" cy="12" r="10" />
            <line x1="12" y1="8" x2="12" y2="12" />
            <line x1="12" y1="16" x2="12.01" y2="16" />
          </svg>
        </div>
        <h2 class="modal-title">Elimina materiale</h2>
        <p class="modal-text">
          Sei sicuro di voler eliminare questo materiale? L'azione non pu√≤
          essere annullata.
        </p>
        <p class="modal-material-name" id="delete-name"></p>
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="closeModal('delete')">
            Annulla
          </button>
          <button class="btn btn-danger" onclick="confirmDelete()">
            Elimina
          </button>
        </div>
      </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast">
      <div class="toast-content">
        <svg
          class="toast-icon"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
          <polyline points="22,4 12,14.01 9,11.01" />
        </svg>
        <span id="toast-message"></span>
      </div>
    </div>

    <script>
      // ========================================
      // CONFIGURAZIONE E DATI
      // ========================================
      const STORAGE = {
        USERS: 'materialstock_users',
        CURRENT: 'materialstock_current',
        MATERIALS: 'materialstock_materials_',
      };

      // Account admin predefinito
      const DEFAULT_ADMIN = {
        name: 'Adelaide Penzo',
        email: 'adelaide.penzo.ar24@itsmarcopolo.it',
        password: 'admin1234',
        organization: 'ITS Marco Polo',
      };

      // 7 Materiali demo con immagini placeholder
      const DEFAULT_MATERIALS = [
        {
          name: 'Travi in legno di abete 300√ó15√ó15cm',
          quantity: 24,
          condition: 'buono',
          location: 'Magazzino A - Scaffale 1',
          origin: 'Padiglione Italia, Biennale di Venezia 2023',
          destination: 'Da assegnare',
          notes:
            "Travi strutturali utilizzate per l'installazione principale. Alcune presentano lievi segni di montaggio (fori per viti). Legno trattato, adatto per riutilizzo.",
          // Immagine travi legno
          image:
            'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&h=300&fit=crop',
        },
        {
          name: 'Mattoni in terracotta artigianali',
          quantity: 450,
          condition: 'ottimo',
          location: 'Magazzino A - Area esterna coperta',
          origin: 'Padiglione Italia, Biennale di Venezia 2023',
          destination: 'Mostra "Architettura Sostenibile" Milano 2024',
          notes:
            'Mattoni fatti a mano da fornace tradizionale toscana. Dimensioni circa 25√ó12√ó6cm. Superficie irregolare con bella patina.',
          // Immagine mattoni
          image:
            'https://images.unsplash.com/photo-1590075865003-e48b568c0443?w=400&h=300&fit=crop',
        },
        {
          name: 'Blocchi in terra cruda compressa',
          quantity: 35,
          condition: 'buono',
          location: 'Magazzino B - Container climatizzato',
          origin: 'Padiglione Italia, Biennale di Venezia 2023',
          destination: 'Da assegnare',
          notes:
            'Blocchi BTC (Compressed Earth Blocks) 40√ó20√ó20cm. Materiale 100% naturale. IMPORTANTE: conservare in ambiente asciutto.',
          // Immagine terra cruda
          image:
            'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=300&fit=crop',
        },
        {
          name: 'Pannelli OSB 244√ó122cm spessore 18mm',
          quantity: 48,
          condition: 'discreto',
          location: 'Magazzino A - Scaffale 3',
          origin: 'Padiglione Italia, Biennale di Venezia 2023',
          destination: 'Workshop Fondazione Arte Contemporanea',
          notes:
            'Pannelli OSB3 per uso strutturale. Alcuni presentano fori da montaggi precedenti. Utilizzabili per strutture temporanee e scenografie.',
          // Immagine pannelli OSB
          image:
            'https://images.unsplash.com/photo-1617791160505-6f00504e3519?w=400&h=300&fit=crop',
        },
        {
          name: 'Corde in canapa naturale √∏20mm',
          quantity: 12,
          condition: 'ottimo',
          location: 'Magazzino B - Scaffale 1',
          origin: 'Padiglione Italia, Biennale di Venezia 2023',
          destination: 'Da assegnare',
          notes:
            'Rotoli da 50 metri ciascuno. Corda in fibra naturale di canapa, alta resistenza (carico rottura 800kg). Conservare in luogo asciutto.',
          // Immagine corde
          image:
            'https://images.unsplash.com/photo-1516562309708-05f3b2b2c238?w=400&h=300&fit=crop',
        },
        {
          name: 'Lastre in sughero pressato 100√ó50cm',
          quantity: 80,
          condition: 'buono',
          location: 'Magazzino A - Scaffale 4',
          origin: 'Padiglione Italia, Biennale di Venezia 2023',
          destination: 'Allestimento Museo Arte Contemporanea Torino',
          notes:
            'Lastre spessore 3cm in sughero portoghese pressato. Materiale fonoassorbente e termoisolante. Superficie con texture naturale.',
          // Immagine sughero
          image:
            'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=400&h=300&fit=crop',
        },
        {
          name: 'Strutture tubolari in acciaio zincato',
          quantity: 16,
          condition: 'da verificare',
          location: 'Magazzino C - Area esterna',
          origin: 'Padiglione Italia, Biennale di Venezia 2023',
          destination: 'Da assegnare',
          notes:
            'Elementi modulari per strutture espositive (sistema a incastro rapido). NECESSARIA VERIFICA: controllare integrit√† giunti e bulloneria.',
          // Immagine strutture metalliche
          image:
            'https://images.unsplash.com/photo-1504917595217-d4dc5ebe6122?w=400&h=300&fit=crop',
        },
      ];

      // Stato applicazione
      let state = {
        currentMaterialId: null,
        sortField: 'name',
        sortDir: 'asc',
        searchQuery: '',
      };

      // ========================================
      // UTILITY STORAGE
      // ========================================
      function getStorage(key) {
        try {
          return JSON.parse(localStorage.getItem(key));
        } catch (e) {
          return null;
        }
      }

      function setStorage(key, val) {
        try {
          localStorage.setItem(key, JSON.stringify(val));
        } catch (e) {
          console.error('Storage error:', e);
        }
      }

      function hash(str) {
        let h = 0;
        for (let i = 0; i < str.length; i++) {
          h = (h << 5) - h + str.charCodeAt(i);
          h = h & h;
        }
        return Math.abs(h).toString(36);
      }

      function genId() {
        return (
          Date.now().toString(36) + Math.random().toString(36).substr(2, 9)
        );
      }

      function formatDate(ts) {
        if (!ts) return '-';
        return new Date(ts).toLocaleDateString('it-IT', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        });
      }

      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ========================================
      // INIZIALIZZAZIONE
      // ========================================
      function init() {
        console.log('üöÄ MaterialStock - Avvio');

        // Crea account admin se non esiste
        let users = getStorage(STORAGE.USERS) || [];
        let admin = users.find(
          (u) => u.email === DEFAULT_ADMIN.email.toLowerCase()
        );

        if (!admin) {
          console.log('üë§ Creazione account admin...');
          admin = {
            id: genId(),
            name: DEFAULT_ADMIN.name,
            email: DEFAULT_ADMIN.email.toLowerCase(),
            passwordHash: hash(DEFAULT_ADMIN.password),
            organization: DEFAULT_ADMIN.organization,
            createdAt: Date.now(),
          };
          users.push(admin);
          setStorage(STORAGE.USERS, users);

          // Carica materiali demo con immagini
          const materials = DEFAULT_MATERIALS.map((m, i) => ({
            id: genId(),
            ...m,
            createdAt: Date.now() - i * 86400000 * 3,
            updatedAt: Date.now() - i * 86400000,
          }));
          setStorage(STORAGE.MATERIALS + admin.id, materials);
          console.log('üì¶ Materiali demo caricati con immagini');
        }

        // Verifica login
        const current = getStorage(STORAGE.CURRENT);
        if (current) {
          showDashboard(current);
        } else {
          showAuth();
        }
      }

      // ========================================
      // AUTENTICAZIONE
      // ========================================
      function showAuth() {
        document.getElementById('auth-screen').classList.add('active');
        document.getElementById('dashboard-screen').classList.remove('active');
      }

      function showDashboard(user) {
        document.getElementById('auth-screen').classList.remove('active');
        document.getElementById('dashboard-screen').classList.add('active');

        document.getElementById('user-name').textContent = user.name;
        document.getElementById('user-org').textContent =
          user.organization || '';

        renderMaterials();
        updateStats();
      }

      function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach((btn, i) => {
          btn.classList.toggle(
            'active',
            (tab === 'login' && i === 0) || (tab === 'register' && i === 1)
          );
        });
        document
          .getElementById('login-form')
          .classList.toggle('active', tab === 'login');
        document
          .getElementById('register-form')
          .classList.toggle('active', tab === 'register');
        document.getElementById('login-error').textContent = '';
        document.getElementById('register-error').textContent = '';
      }

      function handleLogin(e) {
        e.preventDefault();

        const email = document
          .getElementById('login-email')
          .value.trim()
          .toLowerCase();
        const password = document.getElementById('login-password').value;

        const users = getStorage(STORAGE.USERS) || [];
        const user = users.find((u) => u.email === email);

        if (!user || user.passwordHash !== hash(password)) {
          document.getElementById('login-error').textContent =
            'Email o password non corretti';
          return;
        }

        const sessionUser = { ...user };
        delete sessionUser.passwordHash;
        setStorage(STORAGE.CURRENT, sessionUser);

        document.getElementById('login-form').reset();
        showDashboard(sessionUser);
        showToast('Benvenuto, ' + sessionUser.name + '!');
      }

      function handleRegister(e) {
        e.preventDefault();

        const name = document.getElementById('register-name').value.trim();
        const email = document
          .getElementById('register-email')
          .value.trim()
          .toLowerCase();
        const password = document.getElementById('register-password').value;
        const org = document.getElementById('register-org').value.trim();

        let users = getStorage(STORAGE.USERS) || [];

        if (users.find((u) => u.email === email)) {
          document.getElementById('register-error').textContent =
            'Email gi√† registrata';
          return;
        }

        const newUser = {
          id: genId(),
          name,
          email,
          passwordHash: hash(password),
          organization: org,
          createdAt: Date.now(),
        };

        users.push(newUser);
        setStorage(STORAGE.USERS, users);
        setStorage(STORAGE.MATERIALS + newUser.id, []);

        const sessionUser = { ...newUser };
        delete sessionUser.passwordHash;
        setStorage(STORAGE.CURRENT, sessionUser);

        document.getElementById('register-form').reset();
        showDashboard(sessionUser);
        showToast('Account creato con successo!');
      }

      function handleLogout() {
        localStorage.removeItem(STORAGE.CURRENT);
        state.searchQuery = '';
        document.getElementById('search-input').value = '';
        showAuth();
        showToast('Logout effettuato');
      }

      // ========================================
      // GESTIONE MATERIALI
      // ========================================
      function getMaterials() {
        const user = getStorage(STORAGE.CURRENT);
        if (!user) return [];
        return getStorage(STORAGE.MATERIALS + user.id) || [];
      }

      function saveMaterials(materials) {
        const user = getStorage(STORAGE.CURRENT);
        if (!user) return;
        setStorage(STORAGE.MATERIALS + user.id, materials);
      }

      function getMaterialById(id) {
        return getMaterials().find((m) => m.id === id);
      }

      function renderMaterials() {
        let materials = getMaterials();

        // Filtra per ricerca
        if (state.searchQuery) {
          const q = state.searchQuery.toLowerCase();
          materials = materials.filter(
            (m) =>
              m.name.toLowerCase().includes(q) ||
              m.location.toLowerCase().includes(q) ||
              (m.origin && m.origin.toLowerCase().includes(q)) ||
              (m.destination && m.destination.toLowerCase().includes(q)) ||
              (m.notes && m.notes.toLowerCase().includes(q))
          );
        }

        // Ordina
        materials.sort((a, b) => {
          let valA = a[state.sortField] || '';
          let valB = b[state.sortField] || '';

          if (state.sortField === 'quantity') {
            valA = parseInt(valA) || 0;
            valB = parseInt(valB) || 0;
          } else {
            valA = valA.toString().toLowerCase();
            valB = valB.toString().toLowerCase();
          }

          if (valA < valB) return state.sortDir === 'asc' ? -1 : 1;
          if (valA > valB) return state.sortDir === 'asc' ? 1 : -1;
          return 0;
        });

        const allMaterials = getMaterials();
        const isEmpty = allMaterials.length === 0;
        const noResults = !isEmpty && materials.length === 0;

        document.getElementById('table-container').style.display =
          isEmpty || noResults ? 'none' : '';
        document.getElementById('cards-container').style.display =
          isEmpty || noResults ? 'none' : '';
        document
          .getElementById('empty-state')
          .classList.toggle('visible', isEmpty);
        document
          .getElementById('no-results-state')
          .classList.toggle('visible', noResults);

        if (!isEmpty && !noResults) {
          renderTable(materials);
          renderCards(materials);
        }
      }

      function renderTable(materials) {
        const html = materials
          .map(
            (m) => `
                <tr onclick="openDetailModal('${m.id}')">
                    <td>
                        ${
                          m.image
                            ? `<img src="${
                                m.image
                              }" class="table-image" alt="${escapeHtml(
                                m.name
                              )}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                               <div class="table-image-placeholder" style="display:none;">
                                   <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#C4B49A" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                               </div>`
                            : `<div class="table-image-placeholder">
                                   <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#C4B49A" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                               </div>`
                        }
                    </td>
                    <td>
                        <div class="material-name">${escapeHtml(m.name)}</div>
                        <div class="material-location">${escapeHtml(
                          m.location
                        )}</div>
                    </td>
                    <td style="text-align:center; font-weight: 600;">${
                      m.quantity
                    }</td>
                    <td><span class="condition-badge ${m.condition.replace(
                      /\s/g,
                      '-'
                    )}">${m.condition}</span></td>
                    <td class="col-location-header">${escapeHtml(
                      m.location
                    )}</td>
                    <td>
                        <div class="actions-cell">
                            <button class="action-btn edit-btn" onclick="event.stopPropagation(); quickEdit('${
                              m.id
                            }')" title="Modifica rapida">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="action-btn delete-btn" onclick="event.stopPropagation(); quickDelete('${
                              m.id
                            }')" title="Elimina">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `
          )
          .join('');
        document.getElementById('table-body').innerHTML = html;
      }

      function renderCards(materials) {
        const html = materials
          .map(
            (m) => `
                <div class="material-card" onclick="openDetailModal('${m.id}')">
                    ${
                      m.image
                        ? `<img src="${
                            m.image
                          }" class="card-image" alt="${escapeHtml(
                            m.name
                          )}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                           <div class="card-image-placeholder" style="display:none;">
                               <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#C4B49A" stroke-width="1"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                           </div>`
                        : `<div class="card-image-placeholder">
                               <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#C4B49A" stroke-width="1"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                           </div>`
                    }
                    <div class="card-content">
                        <div class="card-header">
                            <h3 class="card-title">${escapeHtml(m.name)}</h3>
                            <span class="condition-badge ${m.condition.replace(
                              /\s/g,
                              '-'
                            )}">${m.condition}</span>
                        </div>
                        <div class="card-details">
                            <div>
                                <div class="card-detail-label">Quantit√†</div>
                                <div class="card-detail-value">${
                                  m.quantity
                                } pezzi</div>
                            </div>
                            <div>
                                <div class="card-detail-label">Collocazione</div>
                                <div class="card-detail-value">${escapeHtml(
                                  m.location
                                )}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `
          )
          .join('');
        document.getElementById('cards-container').innerHTML = html;
      }

      function updateStats() {
        const materials = getMaterials();
        document.getElementById('stat-total').textContent = materials.length;
        document.getElementById('stat-pieces').textContent = materials.reduce(
          (s, m) => s + (parseInt(m.quantity) || 0),
          0
        );
        document.getElementById('stat-good').textContent = materials.filter(
          (m) => m.condition === 'ottimo' || m.condition === 'buono'
        ).length;
      }

      function handleSearch() {
        state.searchQuery = document
          .getElementById('search-input')
          .value.trim();
        renderMaterials();
      }

      function handleSort(field) {
        if (state.sortField === field) {
          state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
        } else {
          state.sortField = field;
          state.sortDir = 'asc';
        }
        renderMaterials();
      }

      // ========================================
      // MODALI
      // ========================================
      function openModal(id) {
        document.getElementById(id + '-modal').classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeModal(id) {
        document.getElementById(id + '-modal').classList.remove('active');
        document.body.style.overflow = '';
      }

      function openDetailModal(id) {
        const m = getMaterialById(id);
        if (!m) return;

        state.currentMaterialId = id;

        const imgEl = document.getElementById('detail-image');
        const placeholderEl = document.getElementById('detail-placeholder');

        if (m.image) {
          imgEl.src = m.image;
          imgEl.style.display = 'block';
          placeholderEl.style.display = 'none';
          imgEl.onerror = () => {
            imgEl.style.display = 'none';
            placeholderEl.style.display = 'flex';
          };
        } else {
          imgEl.style.display = 'none';
          placeholderEl.style.display = 'flex';
        }

        document.getElementById('detail-name').textContent = m.name;
        document.getElementById('detail-condition').textContent = m.condition;
        document.getElementById('detail-condition').className =
          'condition-badge ' + m.condition.replace(/\s/g, '-');
        document.getElementById('detail-quantity').textContent =
          m.quantity + ' ' + (m.quantity === 1 ? 'pezzo' : 'pezzi');
        document.getElementById('detail-location').textContent =
          m.location || '-';
        document.getElementById('detail-origin').textContent = m.origin || '-';
        document.getElementById('detail-destination').textContent =
          m.destination || '-';

        const notesSection = document.getElementById('detail-notes-section');
        if (m.notes) {
          document.getElementById('detail-notes').textContent = m.notes;
          notesSection.style.display = 'block';
        } else {
          notesSection.style.display = 'none';
        }

        document.getElementById('detail-created').textContent =
          'Creato: ' + formatDate(m.createdAt);
        document.getElementById('detail-updated').textContent =
          'Modificato: ' + formatDate(m.updatedAt);

        openModal('detail');
      }

      function openAddModal() {
        state.currentMaterialId = null;
        document.getElementById('form-title').textContent = 'Nuovo Materiale';
        document.getElementById('form-id').value = '';
        document.getElementById('form-name').value = '';
        document.getElementById('form-quantity').value = '1';
        document.getElementById('form-condition').value = 'buono';
        document.getElementById('form-location').value = '';
        document.getElementById('form-origin').value = '';
        document.getElementById('form-destination').value = '';
        document.getElementById('form-notes').value = '';
        resetFormImage();
        openModal('form');
      }

      function openEditModal() {
        const m = getMaterialById(state.currentMaterialId);
        if (!m) return;

        closeModal('detail');

        document.getElementById('form-title').textContent =
          'Modifica Materiale';
        document.getElementById('form-id').value = m.id;
        document.getElementById('form-name').value = m.name;
        document.getElementById('form-quantity').value = m.quantity;
        document.getElementById('form-condition').value = m.condition;
        document.getElementById('form-location').value = m.location;
        document.getElementById('form-origin').value = m.origin || '';
        document.getElementById('form-destination').value = m.destination || '';
        document.getElementById('form-notes').value = m.notes || '';

        if (m.image) {
          document.getElementById('preview-img').src = m.image;
          document.getElementById('image-preview').style.display = 'none';
          document.getElementById('image-uploaded').hidden = false;
        } else {
          resetFormImage();
        }

        setTimeout(() => openModal('form'), 150);
      }

      // Modifica rapida dalla tabella
      function quickEdit(id) {
        state.currentMaterialId = id;
        openEditModal();
      }

      // Eliminazione rapida dalla tabella
      function quickDelete(id) {
        state.currentMaterialId = id;
        const m = getMaterialById(id);
        if (m) {
          document.getElementById('delete-name').textContent = m.name;
          openModal('delete');
        }
      }

      function handleFormSubmit(e) {
        e.preventDefault();

        const id = document.getElementById('form-id').value;
        const data = {
          name: document.getElementById('form-name').value.trim(),
          quantity:
            parseInt(document.getElementById('form-quantity').value) || 0,
          condition: document.getElementById('form-condition').value,
          location: document.getElementById('form-location').value.trim(),
          origin: document.getElementById('form-origin').value.trim(),
          destination: document.getElementById('form-destination').value.trim(),
          notes: document.getElementById('form-notes').value.trim(),
          image: document.getElementById('image-uploaded').hidden
            ? null
            : document.getElementById('preview-img').src,
        };

        let materials = getMaterials();

        if (id) {
          // Aggiorna esistente
          const idx = materials.findIndex((m) => m.id === id);
          if (idx !== -1) {
            materials[idx] = {
              ...materials[idx],
              ...data,
              updatedAt: Date.now(),
            };
            showToast('Materiale aggiornato con successo!');
          }
        } else {
          // Nuovo materiale
          materials.push({
            id: genId(),
            ...data,
            createdAt: Date.now(),
            updatedAt: Date.now(),
          });
          showToast('Materiale aggiunto con successo!');
        }

        saveMaterials(materials);
        closeModal('form');
        renderMaterials();
        updateStats();
      }

      function handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
          showToast('Seleziona un file immagine valido', true);
          return;
        }

        if (file.size > 5 * 1024 * 1024) {
          showToast('Immagine troppo grande (max 5MB)', true);
          return;
        }

        const reader = new FileReader();
        reader.onload = (evt) => {
          // Comprimi immagine
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width,
              h = img.height;
            const maxSize = 800;

            if (w > maxSize || h > maxSize) {
              if (w > h) {
                h = (h * maxSize) / w;
                w = maxSize;
              } else {
                w = (w * maxSize) / h;
                h = maxSize;
              }
            }

            canvas.width = w;
            canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);

            const compressed = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById('preview-img').src = compressed;
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('image-uploaded').hidden = false;
          };
          img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
      }

      function removeImage() {
        resetFormImage();
      }

      function resetFormImage() {
        document.getElementById('form-image-input').value = '';
        document.getElementById('preview-img').src = '';
        document.getElementById('image-preview').style.display = 'flex';
        document.getElementById('image-uploaded').hidden = true;
      }

      function openDeleteModal() {
        const m = getMaterialById(state.currentMaterialId);
        if (!m) return;

        document.getElementById('delete-name').textContent = m.name;
        closeModal('detail');
        setTimeout(() => openModal('delete'), 150);
      }

      function confirmDelete() {
        if (!state.currentMaterialId) return;

        let materials = getMaterials();
        materials = materials.filter((m) => m.id !== state.currentMaterialId);
        saveMaterials(materials);

        state.currentMaterialId = null;
        closeModal('delete');
        renderMaterials();
        updateStats();
        showToast('Materiale eliminato');
      }

      // ========================================
      // TOAST
      // ========================================
      function showToast(msg, isError = false) {
        const toast = document.getElementById('toast');
        document.getElementById('toast-message').textContent = msg;
        toast.classList.toggle('error', isError);
        toast.classList.add('visible');
        setTimeout(() => toast.classList.remove('visible'), 3000);
      }

      // ========================================
      // KEYBOARD
      // ========================================
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          document
            .querySelectorAll('.modal.active')
            .forEach((m) => m.classList.remove('active'));
          document.body.style.overflow = '';
        }
      });

      // ========================================
      // START
      // ========================================
      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
